---
title: MySQLæ€§èƒ½ä¼˜åŒ–ä¹‹Explainæµ…æï¼ˆä¸Šï¼‰
date: 2019-08-19 22:18:54
tags:
    - MySQL
categories:
    - æ•°æ®åº“
    - MySQL
---

**å†™åœ¨å‰é¢**: åœ¨è½¯ä»¶å¼€å‘ä¸­ï¼Œéµå¾ªç€ `first finish then perfect` çš„åŸåˆ™ã€‚å‰æœŸæˆ‘ä»¬å¾€å¾€ä¼šæ›´åŠ å…³æ³¨ç¨‹åºåŠŸèƒ½çš„å®ç°ï¼Œç¼–å†™çš„ `SQL` è¯­å¥ä¹Ÿå¤šä¸ºæ»¡è¶³ä¸šåŠ¡æ‰€éœ€çš„å¢åˆ æ”¹æŸ¥ã€‚å¦‚æœè¿æ°”è¿˜ä¸é”™ï¼Œä¸šåŠ¡åšèµ·æ¥äº†ï¼Œæ•°æ®é‡è¾¾åˆ°ä¸€å®šé‡çº§æ—¶ï¼Œæˆ‘ä»¬å‘ç°ä¸€ä¸ªè¯·æ±‚çš„å“åº”æ—¶é—´ä¼šè¶Šæ¥è¶Šéš¾ä»¥æ¥å—ï¼Œå…¶ä¸­æŸäº›ä¸å†åˆç†çš„ `SQL` å¾€å¾€ä¼šæˆä¸ºæ•´ä¸ªè¯·æ±‚å“åº”ä¸­æ€§èƒ½æ¶ˆè€—å¤§æˆ·ï¼Œç”šè‡³æˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œé‚£ä¹ˆæ­¤æ—¶å¯¹ `SQL` è¯­å¥çš„ä¼˜åŒ–å°±æ˜¾å¾—æ ¼å¤–é‡è¦äº†ã€‚è¦ä¼˜åŒ– `SQL` å°±éœ€è¦å®šä½ `SQL` å­˜åœ¨çš„é—®é¢˜ã€‚`MySQL` æä¾›äº† `explain  + sql` å‘½ä»¤æ¥è·å– `SQL` è¯­å¥æ‰§è¡Œè®¡åˆ’çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬æœ‰å…³å¦‚ä½•è¿æ¥è¡¨ä»¥åŠä»¥ä½•ç§é¡ºåºè¿æ¥è¡¨ã€‚ä»¥ä¸‹ä¸º `explain` å­¦ä¹ ä¸­æ‰€åšç¬”è®°ï¼Œè®°å½•äºæ­¤ğŸ“ä»¥ä¾¿ä»Šåç¿»é˜…ã€‚

é‰´äºç¯‡å¹…: è¿™é‡Œè®°å½•æˆªè‡³ `explain` ä¸­ `type` å‰çš„å­—æ®µ

<!--more-->

å¤‡æ³¨: æ–‡ä¸­ç”¨åˆ°çš„sqlæ•°æ®æ¥è‡ª [employees.sql](https://github.com/inscode/inscode.github.io/blob/master/blog/source/static/myemployees.sql)

---

#### 1: explain èƒ½è·å–åˆ°é‚£äº›ä¿¡æ¯ï¼Ÿ

- è¡¨çš„è¯»å–é¡ºåº

- è¡¨æ•°æ®è¯»å–æ“ä½œï¼ˆ`select`ï¼‰çš„ç±»å‹

- é‚£äº›æ‰€æœ‰é˜”ä»¥è¢«ä½¿ç”¨

- é‚£äº›ç´¢å¼•å®é™…è¢«ä½¿ç”¨

- è¡¨ä¹‹é—´çš„å¼•ç”¨

- æ¯å¼ è¡¨æœ‰å¤šå°‘è¡Œè¢«ä¼˜åŒ–å™¨æŸ¥è¯¢

#### 2: explain çš„ä½¿ç”¨åŠå…¶å­—æ®µè¯´æ˜

```SQL
-- å¾—åˆ°çš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹è¡¨
mysql> explain select * from employees;
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------+
| id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------+
|  1 | SIMPLE      | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  107 |   100.00 | NULL  |
+----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------+
1 row in set, 1 warning (0.01 sec)
```
##### 2.1: id å­—æ®µ

**å«ä¹‰æˆ–ç”¨é€”**: select æŸ¥è¯¢çš„åºåˆ—å·ï¼ŒåŒ…å«ä¸€ç»„æ•°å­—ï¼Œè¡¨ç¤ºæŸ¥è¯¢ä¸­æ‰§è¡Œ select å­—å¥æˆ–æ˜¯æ“ä½œè¡¨çš„é¡ºåº

**id çš„ä¸‰ç§æƒ…å½¢**

- id ç›¸åŒï¼Œæ‰§è¡Œé¡ºåºè‡ªä¸Šè€Œä¸‹

    ```SQL
    -- æŸ¥è¯¢å‘˜å·¥åï¼Œéƒ¨é—¨å
    mysql> explain SELECT employees.employee_id,employees.last_name, departments.department_name
        -> from employees
        -> inner join departments
        -> on employees.department_id = departments.department_id;
    +----+-------------+-------------+------------+------+---------------+------------+---------+---------------------------------------+------+----------+-------+
    | id | select_type | table       | partitions | type | possible_keys | key        | key_len | ref                                   | rows | filtered | Extra |
    +----+-------------+-------------+------------+------+---------------+------------+---------+---------------------------------------+------+----------+-------+
    |  1 | SIMPLE      | departments | NULL       | ALL  | PRIMARY       | NULL       | NULL    | NULL                                  |   27 |   100.00 | NULL  |
    |  1 | SIMPLE      | employees   | NULL       | ref  | dept_id_fk    | dept_id_fk | 5       | myemployees.departments.department_id |    9 |   100.00 | NULL  |
    +----+-------------+-------------+------------+------+---------------+------------+---------+---------------------------------------+------+----------+-------+
    2 rows in set, 1 warning (0.00 sec)
    ```
    è¯´æ˜: è¡¨è¯»å–é¡ºåºæ˜¯å…ˆ `departments` å `departments`ã€‚

- id ä¸åŒï¼Œå¦‚æœæ˜¯å­æŸ¥è¯¢ï¼Œid çš„åºå·ä¼šé€’å¢ï¼Œid å€¼è¶Šå¤§å…¶ä¼˜å…ˆçº§è¶Šé«˜ï¼Œå°±è¶Šå…ˆè¢«æ‰§è¡Œã€‚

    ```SQL

    mysql> explain select * from employees where salary = (select max(salary) from employees);
    +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
    | id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
    +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
    |  1 | PRIMARY     | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  107 |    10.00 | Using where |
    |  2 | SUBQUERY    | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  107 |   100.00 | NULL        |
    +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
    2 rows in set, 1 warning (0.00 sec)
    ```
    è¯´æ˜: è¡¨æ‰§è¡Œé¡ºåºæ˜¯å…ˆæ‰§è¡Œ id ä¸º 2 çš„å­æŸ¥è¯¢åæ‰§è¡Œ id ä¸º 1 çš„ä¸»æŸ¥è¯¢ã€‚

- id ç›¸åŒä¸åŒï¼ŒåŒæ—¶å­˜åœ¨ï¼ˆâ“è¿™æ˜¯ä»€ä¹ˆé¬¼ğŸ‘»ï¼‰

    ```SQL
    mysql> æ²¡æ‰¾åˆ°ä¾‹å­ï¼Œä¸‹é¢å°±åªè¡¨ç¤ºä¸€ä¸‹äº†ğŸ˜‚ğŸ˜‚ğŸ˜‚(åªå…³æ³¨ id å°±è¡Œ)
    +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
    | id | select_type | table     | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |
    +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
    |  1 | PRIMARY     | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  107 |    10.00 | Using where |
    |  1 | PRIMARY     | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  107 |   100.00 | NULL        |
    |  2 | SUBQUERY    | employees | NULL       | ALL  | NULL          | NULL | NULL    | NULL |  107 |   100.00 | NULL        |
    +----+-------------+-----------+------------+------+---------------+------+---------+------+------+----------+-------------+
    2 rows in set, 1 warning (0.00 sec)
    ```
    è¯´æ˜: id å­—æ®µä¸­æ•°å­—å¤§çš„å…ˆæ‰§è¡Œï¼Œå³æ˜¯ `2å…ˆæ‰§è¡Œ`ï¼Œç„¶åå­˜åœ¨ä¸¤ä¸ªè¯„ä»·çš„ 1ï¼ŒæŒ‰ `è‡ªä¸Šè€Œä¸‹çš„å…ˆåé¡ºåºæ‰§è¡Œ`ã€‚


##### 2.2: `select_type` å­—æ®µ    

**å«ä¹‰æˆ–ç”¨é€”**: è¡¨ç¤º `SELECT` çš„ç±»å‹ï¼Œä¸»è¦ç”¨äºåŒºåˆ« æ™®é€šæŸ¥è¯¢ã€è”åˆæŸ¥è¯¢ã€å­æŸ¥è¯¢ç­‰å¤æ‚æŸ¥è¯¢ã€‚å¸¸è§çš„å–å€¼å¦‚ä¸‹

- **1-SIMPLE:**  ç®€å• select æŸ¥è¯¢ï¼Œä¸åŒ…å«å­æŸ¥è¯¢æˆ–è€…è¿æ¥æŸ¥è¯¢ï¼ˆunionï¼‰

- **2-PRIMARY:**  ä¸»æŸ¥è¯¢ï¼Œå³æ˜¯å¤–å±‚çš„æŸ¥è¯¢ï¼ˆæŸ¥è¯¢ä¸­åŒ…å«äº†å­æŸ¥è¯¢ï¼‰ï¼ŒPRIMARY æ˜¯æœ€ååŠ è½½çš„æŸ¥è¯¢

- **3-SUBQUERY:**  åœ¨ SELECT æˆ– where æŸ¥è¯¢åŒ…å«äº† å­æŸ¥è¯¢

- **4-DERIVED:**  åœ¨ From åˆ—è¡¨ä¸­åŒ…å«çš„å­æŸ¥è¯¢è¢«æ ‡è®°ä¸º DEVIRED(è¡ç”Ÿ)ã€‚MySQLä¼šé€’å½’æ‰§è¡Œè¿™äº›å­æŸ¥è¯¢ï¼ŒæŠŠç»“æœæ”¾åœ¨ä¸´æ—¶è¡¨ä¸­ï¼ˆä¼šå¢åŠ ç³»ç»Ÿæ¶ˆè€—ï¼‰

- **5-UNION:**  è‹¥ç¬¬äºŒä¸ª SELECT å‡ºç°åœ¨ UNION ä¹‹åï¼Œåˆ™æ ‡è®°ä¸º UNION; è‹¥ UNION åŒ…å«åœ¨ FROM å­—å¥çš„å­æŸ¥è¯¢ä¸­ï¼Œå¤–å±‚çš„ SELECT è¢«æ ‡è®° DEVIRED

- **6-UNION RESULT:**  ä¸¤ç§ UNION ç»“æœçš„åˆå¹¶

    ```SQL
    mysql> explain select * from employees where email like '%a%' union select * from employees where department_id>90;
    +----+--------------+------------+------------+-------+---------------+------------+---------+------+------+----------+-----------------------+
    | id  | select_type  | table      | partitions | type  | possible_keys | key        | key_len | ref  | rows | filtered | Extra                 |
    +-----+--------------+------------+------------+-------+---------------+------------+---------+------+------+----------+-----------------------+
    |  1  | PRIMARY      | employees  | NULL       | ALL   | NULL          | NULL       | NULL    | NULL |  107 |    11.11 | Using where           |
    |  2  | UNION        | employees  | NULL       | range | dept_id_fk    | dept_id_fk | 5       | NULL |    8 |   100.00 | Using index condition |
    | NULL| UNION RESULT | <union1,2> | NULL       | ALL   | NULL          | NULL       | NULL    | NULL | NULL |     NULL | Using temporary       |
    +----+--------------+------------+------------+-------+---------------+------------+---------+------+------+----------+-----------------------+
    3 rows in set, 1 warning (0.00 sec)   
    ```

##### 2.3: `table` å­—æ®µ

**å«ä¹‰æˆ–ç”¨é€”**: è¾“å‡ºç»“æœé›†çš„è¡¨

##### 2.4: `type` å­—æ®µ

**å«ä¹‰æˆ–ç”¨é€”**: æ˜¾ç¤ºæŸ¥è¯¢ä½¿ç”¨äº†ä½•ç§è¿æ¥ç±»å‹ã€‚ç»“æœå€¼ä»æœ€å¥½åˆ°æœ€åä¾æ¬¡å¦‚ä¸‹ï¼Œé€šå¸¸æ¥è¯´ä¿è¯ type å€¼èƒ½è¾¾åˆ° Rangeã€‚

**`system` > `const` > `eq_ref` > `ref` > `range` > `index` > `all`**

- **1-system:**  å•è¡¨åªæœ‰ä¸€è¡Œè®°å½•ï¼ˆç­‰äºç³»ç»Ÿè¡¨ï¼‰ï¼Œæ˜¯constè¿æ¥ç±»å‹çš„ç‰¹ä¾‹ã€‚å¯ä»¥å¿½ç•¥ä¸è®¡

- **2-const:**  è¯¥è¡¨æœ€å¤šåªæœ‰ä¸€ä¸ªåŒ¹é…è¡Œï¼Œåœ¨æŸ¥è¯¢å¼€å¤´è¯»å–ã€‚å› ä¸ºåªæœ‰ä¸€è¡Œï¼Œæ‰€ä»¥ä¼˜åŒ–å™¨çš„å…¶ä½™éƒ¨åˆ†å¯ä»¥å°†æ­¤è¡Œä¸­åˆ—çš„å€¼è§†ä¸ºå¸¸é‡ã€‚constè¡¨éå¸¸å¿«ï¼Œå› ä¸ºå®ƒä»¬åªè¯»ä¸€æ¬¡ã€‚const å°† PRIMARY KEYæˆ– UNIQUEç´¢å¼•çš„æ‰€æœ‰éƒ¨åˆ†ä¸å¸¸é‡å€¼è¿›è¡Œæ¯”è¾ƒæ—¶ä½¿ç”¨ã€‚

    ```SQL
    -- ä¸»é”® employee_id = 100 æ˜¯ä¸€ä¸ªå¸¸é‡ï¼Œå¯¹åº”ä¸€æ¡è®°å½•ï¼Œ type ä¸º const
    mysql> explain select * from (select * from employees where employee_id = 100) as tmp;
    +----+-------------+-----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
    | id | select_type | table     | partitions | type  | possible_keys | key     | key_len | ref   | rows | filtered | Extra |
    +----+-------------+-----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
    |  1 | SIMPLE      | employees | NULL       | const | PRIMARY       | PRIMARY | 4       | const |    1 |   100.00 | NULL  |
    +----+-------------+-----------+------------+-------+---------------+---------+---------+-------+------+----------+-------+
    ```

- **3-eq_ref:**  å”¯ä¸€æ€§ç´¢å¼•ï¼ˆ`PRIMARY KEY` æˆ– `UNIQUE NOT NULL`ï¼‰æ‰«æï¼Œå¯¹äºæ¯ä¸ªç´¢å¼•é”®ï¼Œè¡¨ä¸­åªæœ‰ä¸€ä¸ªè®°å½•ä¸ä¹‹åŒ¹é…ã€‚å¸¸è§äºä¸»é”®æˆ–å”¯ä¸€ç´¢å¼•

    ```SQL
    -- job_id='AC_MGR' åœ¨employeesè¡¨ä¸­åªæœ‰ä¸€æ¡è®°å½•;
    mysql> explain select * from employees,departments where employees.job_id='AC_MGR' and departments.department_id = employees.department_id;
    +----+-------------+-------------+------------+--------+----------------------+-----------+---------+-------------------------------------+------+----------+-------------+
    | id | select_type | table       | partitions | type   | possible_keys        | key       | key_len | ref                                 | rows | filtered | Extra       |
    +----+-------------+-------------+------------+--------+----------------------+-----------+---------+-------------------------------------+------+----------+-------------+
    |  1 | SIMPLE      | employees   | NULL       | ref    | dept_id_fk,job_id_fk | job_id_fk | 23      | const                               |    1 |   100.00 | Using where |
    |  1 | SIMPLE      | departments | NULL       | eq_ref | PRIMARY              | PRIMARY   | 4       | myemployees.employees.department_id |    1 |   100.00 | NULL        |
    +----+-------------+-------------+------------+--------+----------------------+-----------+---------+-------------------------------------+------+----------+-------------+
    ```

- **4-ref:**  éå”¯ä¸€æ€§ç´¢å¼•æ‰«æ, è¿”å›åŒ¹é…æŸä¸ªå•ç‹¬å€¼çš„æ‰€æœ‰è¡Œè®°å½•ã€‚

    ```SQL
    -- job_id æ˜¯ä¸€ä¸ªç´¢å¼•ï¼Œé…ç½®job_id = 'SA_REP' çš„æ‰€æœ‰è®°å½•
    mysql> explain select * from employees where job_id='SA_REP';
    +----+-------------+-----------+------------+------+---------------+-----------+---------+-------+------+----------+-------+
    | id | select_type | table     | partitions | type | possible_keys | key       | key_len | ref   | rows | filtered | Extra |
    +----+-------------+-----------+------------+------+---------------+-----------+---------+-------+------+----------+-------+
    |  1 | SIMPLE      | employees | NULL       | ref  | job_id_fk     | job_id_fk | 23      | const |   30 |   100.00 | NULL  |
    +----+-------------+-----------+------------+------+---------------+-----------+---------+-------+------+----------+-------+
    ```

- **5-range:** ç´¢å¼•ä»…æ£€ç´¢ç»™å®šèŒƒå›´å†…çš„è¡Œï¼Œä½¿ç”¨ç´¢å¼•é€‰æ‹©è¡Œ   

    ```SQL
    -- ä½¿ç”¨ =ï¼Œ <>ï¼Œ >ï¼Œ >=ï¼Œ <ï¼Œ <=ï¼Œ IS NULLï¼Œ <=>ï¼Œ BETWEENï¼Œ LIKEï¼Œæˆ– IN()è¿ç®—ç¬¦
    mysql> explain select * from employees where employee_id>100;
    +----+-------------+-----------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
    | id | select_type | table     | partitions | type  | possible_keys | key     | key_len | ref  | rows | filtered | Extra       |
    +----+-------------+-----------+------------+-------+---------------+---------+---------+------+------+----------+-------------+
    |  1 | SIMPLE      | employees | NULL       | range | PRIMARY       | PRIMARY | 4       | NULL |  106 |   100.00 | Using where |
    +----+-------------+-----------+------------+-------+---------------+---------+---------+------+------+----------+-------------+    
    ```

- **6-index:** `index` ä¸ `all` çš„åŒºåˆ«ä¸º `index` ç±»å‹åªéå†ç´¢å¼•æ•°ğŸŒ²ï¼Œæ‰€ä»¥æ¯” `all` å¿«ã€‚å› ä¸ºç´¢å¼•æ–‡ä»¶é€šå¸¸æ¯”æ•°æ®æ–‡ä»¶å°ï¼Œè™½ç„¶ä¸¤è€…éƒ½æ˜¯æ‰«æå…¨è¡¨ï¼Œä½†æ˜¯ `index` ä»ç´¢å¼•ä¸­è¯»å–ï¼Œè€Œ `all` æ˜¯ä»ç¡¬ç›˜ä¸­è¯»å–ã€‚

    ```SQL
    -- æŸ¥çœ‹è¡¨ departments çš„ç´¢å¼•æƒ…å†µ
    mysql> show index from departments;
    +-------------+------------+-----------+--------------+---------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
    | Table       | Non_unique | Key_name  | Seq_in_index | Column_name   | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
    +-------------+------------+-----------+--------------+---------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
    | departments |          0 | PRIMARY   |            1 | department_id | A         |          27 |     NULL | NULL   |      | BTREE      |         |               |
    | departments |          1 | loc_id_fk |            1 | location_id   | A         |           7 |     NULL | NULL   | YES  | BTREE      |         |               |
    +-------------+------------+-----------+--------------+---------------+-----------+-------------+----------+--------+------+------------+---------+---------------+

    -- è¦†ç›–ç´¢å¼•
    mysql> explain select department_id, location_id from departments;
    +----+-------------+-------------+------------+-------+---------------+-----------+---------+------+------+----------+-------------+
    | id | select_type | table       | partitions | type  | possible_keys | key       | key_len | ref  | rows | filtered | Extra       |
    +----+-------------+-------------+------------+-------+---------------+-----------+---------+------+------+----------+-------------+
    |  1 | SIMPLE      | departments | NULL       | index | NULL          | loc_id_fk | 5       | NULL |   27 |   100.00 | Using index |
    +----+-------------+-------------+------------+-------+---------------+-----------+---------+------+------+----------+-------------+

    -- manager_idä¸æ˜¯ç´¢å¼•å­—æ®µ
    mysql> explain select department_id, location_id, manager_id from departments;
    +----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
    | id | select_type | table       | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra |
    +----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
    |  1 | SIMPLE      | departments | NULL       | ALL  | NULL          | NULL | NULL    | NULL |   27 |   100.00 | NULL  |
    +----+-------------+-------------+------------+------+---------------+------+---------+------+------+----------+-------+
    ```


```
explain select * from employees where salary='20000';
```
---

æœªå®Œå¾…ç»­
