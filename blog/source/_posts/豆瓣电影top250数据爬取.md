---
title: è±†ç“£ç”µå½±top250æ•°æ®çˆ¬å–
date: 2019-08-10 18:19:03
tags:
    - Go
    - çˆ¬è™«
categories:
    - Golang
---

###### å£°æ˜ï¼šä¸€ä¸‹å†…å®¹ä»…ä¾›æŠ€æœ¯å­¦ä¹ 

ç®€è¿°ï¼šçˆ¬å–è±†ç“£ç”µå½± `top 250` çš„åŸºç¡€ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç”µå½±ğŸ¬åï¼Œè¯„åˆ†ï¼Œè¯„ä»·äººæ•°ï¼Œç”µå½±é“¾æ¥ã€‚
<!--more-->


```golang
package main

import (
    "fmt"
    "strconv"
    "net/http"
    "io"
    "regexp"
    "os"
)

func main() {
    var start int //èµ·å§‹é¡µ
    var end int   //ç»“æŸé¡µ
    fmt.Print("è¯·è¾“å…¥çˆ¬å–çš„èµ·å§‹é¡µ:")
    fmt.Scanln(&start)
    fmt.Print("è¯·è¾“å…¥çˆ¬å–çš„ç»“æŸé¡µ:")
    fmt.Scanln(&end)
    toWorking(start, end)
}

func toWorking(start, end int) {
    fmt.Printf("èµ·å§‹ç»“æŸé¡µæ˜¯%d : %d\n", start, end)

    pageChan := make(chan int)
    for i := start; i <= end; i++ {
        go SpiderDoubanPage(i, pageChan)
    }

    for i := start; i <= end; i++ {
        //å¼€å¯åç¨‹
        fmt.Printf("ç¬¬ %d é¡µ çˆ¬å–å®Œæˆ\n", <-pageChan)
    }
}

func SpiderDoubanPage(i int, pageChan chan int) {
    //https://movie.douban.com/top250?start=0&filter=
    //https://movie.douban.com/top250?start=25&filter=
    //https://movie.douban.com/top250?start=50&filter=
    url := "https://movie.douban.com/top250?start=" + strconv.Itoa((i-1)*25)

    //çˆ¬å–urlé¡µé¢å†…å®¹ã€æ¨ªå‘çˆ¬å–ã€‘
    result, err := httpGetDoubanUrlContent(url)
    if err != nil {
        fmt.Println("err messageï¼š", err)
        return
    }

    //fmt.Println(result)
    //ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æå†…å®¹---ç”µå½±åç§°
    film_pat := regexp.MustCompile(`width="100" alt="(.*?)"`)
    FilmNames := film_pat.FindAllStringSubmatch(result, -1)

    //ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æå†…å®¹---ç”µå½±åˆ†æ•°
    score_pat := regexp.MustCompile(`v:average">(?s:(.*?))<`)
    filmScores := score_pat.FindAllStringSubmatch(result, -1)

    //ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æå†…å®¹---è¯„ä»·äººæ•°
    people_pat := regexp.MustCompile(`<span>(?s:(\d*?))äººè¯„ä»·</span>`)
    peopleNum := people_pat.FindAllStringSubmatch(result, -1)

    //ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æå†…å®¹---ç”µå½±è¯¦æƒ…é¡µurl
    film_url_pat := regexp.MustCompile(`<a href="(.*?)" class="">`)
    filmUrls := film_url_pat.FindAllStringSubmatch(result, -1)

    //ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼è§£æå†…å®¹---ç”µå½±åºå·
    film_order_pat := regexp.MustCompile(`<em class="">(\d*)</em>`)
    filmOrders := film_order_pat.FindAllStringSubmatch(result, -1)

    saveToFile(i, filmOrders, FilmNames, filmScores, peopleNum, filmUrls)

    pageChan <- i

}

func httpGetDoubanUrlContent(url string) (result string, err error) {
    resp, err1 := http.Get(url)
    if err1 != nil {
        err = err1
        return
    }

    defer resp.Body.Close()

    buffer := make([]byte, 8192)
    for {
        n, err2 := resp.Body.Read(buffer)
        if n == 0 {
            fmt.Println("è¯»å–ç½‘é¡µå®Œæˆ")
            break
        }

        if err2 != nil && err2 != io.EOF {
            err = err2
            return
        }
        result += string(buffer[:n])
    }
    return
}

func saveToFile(idx int, filmOrders, filmNames, filmScores, peopleNum, filmUrls [][]string) {
    //å°†è¯»å–åˆ°çš„æ•°æ®å­˜å‚¨å­˜å‚¨ä¸ºæ–‡ä»¶
    dir, _ := os.Getwd()
    filePath := dir + "douban_top_" + strconv.Itoa(idx) + ".txt"

    file, err := os.Create(filePath)
    if err != err {
        fmt.Println("os Create errï¼š", err.Error())
        return
    }

    defer file.Close() //ä¿å­˜å¥½ä¸€ä¸ªæ–‡ä»¶å°±å…³é—­ä¸€ä¸ªæ–‡ä»¶

    file.WriteString(
        "åºå·" +
            "\t" + "ç”µå½±åç§°" +
            "\t" + "ç”µå½±è¯„åˆ†" +
            "\t" + "è¯„ä»·äººæ•°" +
            "\t" + "é“¾æ¥åœ°å€" +
            "\n")
    for i := 0; i < len(filmNames); i++ {
        file.WriteString(
            filmOrders[i][1] +
                "\t" + filmNames[i][1] +
                "\t" + filmScores[i][1] +
                "\t" + peopleNum[i][1] +
                "\t" + filmUrls[i][1] +
                "\n")
    }
}


```

##### çˆ¬å–æ ·æœ¬å¦‚ä¸‹ `eg:crawlerdouban_top_1.txt`
```txt
åºå·    ç”µå½±åç§°    ç”µå½±è¯„åˆ†    è¯„ä»·äººæ•°    é“¾æ¥åœ°å€
1    è‚–ç”³å…‹çš„æ•‘èµ    9.7    1535695    https://movie.douban.com/subject/1292052/
2    éœ¸ç‹åˆ«å§¬    9.6    1136522    https://movie.douban.com/subject/1291546/
3    è¿™ä¸ªæ€æ‰‹ä¸å¤ªå†·    9.4    1388824    https://movie.douban.com/subject/1295644/
4    é˜¿ç”˜æ­£ä¼     9.4    1199279    https://movie.douban.com/subject/1292720/
5    ç¾ä¸½äººç”Ÿ    9.5    702825    https://movie.douban.com/subject/1292063/
6    åƒä¸åƒå¯»    9.3    1231099    https://movie.douban.com/subject/1291561/
7    æ³°å¦å°¼å…‹å·    9.4    1140842    https://movie.douban.com/subject/1292722/
8    è¾›å¾·å‹’çš„åå•    9.5    623915    https://movie.douban.com/subject/1295124/
9    ç›—æ¢¦ç©ºé—´    9.3    1189561    https://movie.douban.com/subject/3541415/
10    å¿ çŠ¬å…«å…¬çš„æ•…äº‹    9.3    795328    https://movie.douban.com/subject/3011091/
11    æœºå™¨äººæ€»åŠ¨å‘˜    9.3    788458    https://movie.douban.com/subject/2131459/
12    ä¸‰å‚»å¤§é—¹å®è±å    9.2    1075170    https://movie.douban.com/subject/3793023/
13    æ”¾ç‰›ç­çš„æ˜¥å¤©    9.3    748223    https://movie.douban.com/subject/1291549/
14    æµ·ä¸Šé’¢ç´å¸ˆ    9.2    872907    https://movie.douban.com/subject/1292001/
15    æ¥šé—¨çš„ä¸–ç•Œ    9.2    832134    https://movie.douban.com/subject/1292064/
16    å¤§è¯è¥¿æ¸¸ä¹‹å¤§åœ£å¨¶äº²    9.2    835440    https://movie.douban.com/subject/1292213/
17    æ˜Ÿé™…ç©¿è¶Š    9.3    854952    https://movie.douban.com/subject/1889243/
18    é¾™çŒ«    9.2    739493    https://movie.douban.com/subject/1291560/
19    ç†”ç‚‰    9.3    492270    https://movie.douban.com/subject/5912992/
20    æ•™çˆ¶    9.3    536821    https://movie.douban.com/subject/1291841/
21    æ— é—´é“    9.2    686756    https://movie.douban.com/subject/1307914/
22    ç–¯ç‹‚åŠ¨ç‰©åŸ    9.2    961506    https://movie.douban.com/subject/25662329/
23    å½“å¹¸ç¦æ¥æ•²é—¨    9.1    870538    https://movie.douban.com/subject/1849031/
24    æ€¦ç„¶å¿ƒåŠ¨    9.0    971877    https://movie.douban.com/subject/3319755/
25    è§¦ä¸å¯åŠ    9.2    569502    https://movie.douban.com/subject/6786002/

```